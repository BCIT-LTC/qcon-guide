# Default LTC GitLab CI/CD Source Project Pipeline
#
## Requirements
#   - this file, with "CLUSTER_NAME" set (bottom of script)
#   - a working `Dockerfile` in this project's root
#   - a deployment package for cluster deployment (see docs)
#
## General Pipeline Steps
#   1. Gather info
#   2. Build Image
#   3. Deploy to a cluster
#     - main branch deploys to staging/production; other branches deploy to a dev cluster for review

stages:
  - get info
  - test
  - publish
  - cleanup

## Project initialization
#   - a project access token is required and created on the first run. If the pipeline fails,
#     please wait 5 minutes and re-try after a token has been created.
project init:
  stage: get info
  extends:
    - ".project_init"

## Determine if there are existing git tags or a new tag is required
get info:
  stage: get info
  extends:
    - ".get_info"

## Build image and push to project registry
build image:
  stage: publish
  extends:
    - ".build_image"
    - ".build_image_rules"

## Deploy feat/fix branch package to dev cluster for review
#   - uses a deployment package with a `dev` overlay (generic-dev is used if one hasn't been initialized)
deploy review:
  stage: publish
  variables:
    TARGET_ENV: dev
  extends:
    - ".deploy_review"
    - ".deploy_review_rules"

## Deploy staging/production packages
#   - must have a deployment package with `staging` and `production` overlays
#   - triggers pipelines in GitLab "Deployments/{projectName}" project
deploy to staging:
  stage: publish
  variables:
    TARGET_ENV: staging
  extends:
    - ".deploy"
    - ".deploy_staging_rules"
  environment:
    name: staging
    url: https://${STAGING_HOST}/$CI_PROJECT_NAME
  tags:
    - staging

deploy to production:
  stage: publish
  variables:
    TARGET_ENV: production
  extends:
    - ".deploy"
    - ".deploy_prod_rules"
  environment:
    name: production
    url: https://${PROD_HOST}/${CI_PROJECT_NAME}
  tags:
    - production

## Removes dev cluster review (and all assets in the review branch namespace)
stop review:
  stage: cleanup
  extends:
    - ".undeploy_review"
    - ".undeploy_review_rules"

#
## ---------- Pipeline configuration ----------
#
variables: # other global variables are set in GitLab Admin
  CLUSTER_NAME: dev-cp # options: dev-cp, dev-vsm
  # GENERIC_DEPLOYMENT: "true"
  #
  #   - if GENERIC_DEPLOYMENT is set to anything but "true", the pipeline expects a deployment package
  #     to exist in the "Deployments" GitLab group. Create a deployment package following the
  #     guide in "Deployments/CI Config".
  #
  #   - see https://infrastructure-documentation.dev.ltc.bcit.ca/ for additional info.
  #
  # DEPLOY_PKG_INIT: "true"       # to create an initial project deployment package
  DEPLOY_PKG_PROJECT_ID: "422"
  COMMON_NAMESPACE: "qcon" # combine apps into one namespace
  PIPELINE_DEBUG: "true"
#
## ---------- It's generally bad to change anything below here ----------
#
## Include common scripts
include:
  - project: deployments/ci-config
    file:
      - project-init.yml
      - get-info.yml
      - build.yml
      - deploy.yml
      - ".deploy-hydrate.yml"
      - ".vault.yml"
      - ".rules.yml"
      - SAST.gitlab-ci.yml
      - Secret-Detection.gitlab-ci.yml

## Specify which runner should pick up pipeline jobs
default:
  tags:
    - "${CLUSTER_NAME}"

cache:
  key: $CI_COMMIT_REF_SLUG

## Configure security scanning
sast:
  stage: test
  extends:
    - ".deploy_prod_rules"

## Configure merge request pipelines
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"
      when: never
    - if: "$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS"
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
